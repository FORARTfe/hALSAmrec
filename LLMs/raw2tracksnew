#!/bin/bash

# raw2tracks: Extracts multitrack WAVs from a raw audio file, parsing parameters from filename.
# Usage: ./raw2tracks <timestamp>_<channels>-<rate>-<bitformat>.raw

set -e

RAWFILE="$1"

if [[ -z "$RAWFILE" ]]; then
  echo "Usage: $0 filename"
  echo "Expected filename format: <timestamp>_<channels>-<rate>-<bitformat>.raw"
  exit 1
fi

BASENAME=$(basename "$RAWFILE" .raw)

# Parse <timestamp>_<channels>-<rate>-<bitformat>
if [[ "$BASENAME" =~ ^([^_]+)_([0-9]+)-([0-9]+)-(.+)$ ]]; then
  TIMESTAMP="${BASH_REMATCH[1]}"
  CHANNELS="${BASH_REMATCH[2]}"
  RATE="${BASH_REMATCH[3]}"
  BITFORMAT="${BASH_REMATCH[4]}"
else
  echo "Error: Could not parse filename. Expected format: <timestamp>_<channels>-<rate>-<bitformat>.raw"
  exit 1
fi

# Map BITFORMAT to Sox parameters
BITS=""
ENCODING=""
ENDIAN=""

case "$BITFORMAT" in
  S8)       BITS=8;  ENCODING="signed-integer";   ENDIAN="";;
  U8)       BITS=8;  ENCODING="unsigned-integer"; ENDIAN="";;
  S16_LE)   BITS=16; ENCODING="signed-integer";   ENDIAN="little";;
  S16_BE)   BITS=16; ENCODING="signed-integer";   ENDIAN="big";;
  U16_LE)   BITS=16; ENCODING="unsigned-integer"; ENDIAN="little";;
  U16_BE)   BITS=16; ENCODING="unsigned-integer"; ENDIAN="big";;
  S24_LE)   BITS=24; ENCODING="signed-integer";   ENDIAN="little";;
  S24_BE)   BITS=24; ENCODING="signed-integer";   ENDIAN="big";;
  U24_LE)   BITS=24; ENCODING="unsigned-integer"; ENDIAN="little";;
  U24_BE)   BITS=24; ENCODING="unsigned-integer"; ENDIAN="big";;
  S32_LE)   BITS=32; ENCODING="signed-integer";   ENDIAN="little";;
  S32_BE)   BITS=32; ENCODING="signed-integer";   ENDIAN="big";;
  U32_LE)   BITS=32; ENCODING="unsigned-integer"; ENDIAN="little";;
  U32_BE)   BITS=32; ENCODING="unsigned-integer"; ENDIAN="big";;
  FLOAT_LE)    BITS=32; ENCODING="float"; ENDIAN="little";;
  FLOAT_BE)    BITS=32; ENCODING="float"; ENDIAN="big";;
  FLOAT64_LE)  BITS=64; ENCODING="float"; ENDIAN="little";;
  FLOAT64_BE)  BITS=64; ENCODING="float"; ENDIAN="big";;
  DSD_U8)      BITS=8;  ENCODING="dsd"; ENDIAN="";;
  DSD_U16_LE)  BITS=16; ENCODING="dsd"; ENDIAN="little";;
  DSD_U16_BE)  BITS=16; ENCODING="dsd"; ENDIAN="big";;
  DSD_U32_LE)  BITS=32; ENCODING="dsd"; ENDIAN="little";;
  DSD_U32_BE)  BITS=32; ENCODING="dsd"; ENDIAN="big";;
  DSD_U8_BE)   BITS=8;  ENCODING="dsd"; ENDIAN="big";;
  *)
    echo "Error: Unknown bitformat: $BITFORMAT"
    exit 1
    ;;
esac

OUTDIR="$TIMESTAMP"
mkdir -p "$OUTDIR"

echo "Extracting $CHANNELS tracks from $RAWFILE ($BITS bits, $RATE Hz, $ENCODING, $ENDIAN endian):"

CHANNEL=$CHANNELS
while [[ $CHANNEL -ge 1 ]]; do
  FILENAME="track${CHANNEL}.wav"
  echo "- writing $OUTDIR/$FILENAME"
  sox --type raw --bits "$BITS" --channels "$CHANNELS" --encoding "$ENCODING" --rate "$RATE" ${ENDIAN:+--endian $ENDIAN} "$RAWFILE" "$OUTDIR/$FILENAME" remix "$CHANNEL"
  CHANNEL=$((CHANNEL - 1))
done

echo "$CHANNELS tracks successfully extracted!"
